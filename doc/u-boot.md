Notes on U-Boot for Zedboard
============================

Boot flow
---------

The Xilinx Zynq SoC comes with a BootROM that is capable of locating and
loading a file called `boot.bin` on a FAT partition of an attached SD card.
`boot.bin` is provided by U-Boot.

Typically, `boot.bin` contains the Secondary Program Loader (SPL), which is
then responsible for loading U-Boot proper.


ps7\_init
---------

Soon after the BootROM hands control over to the U-Boot SPL, a function called
`ps7_init()` runs to finish initialization of the hardware. This function is
generated by the Xilinx tooling. U-Boot contains variants of it for various
Zynq boards, including the Zedboard.

See the U-Boot configuration option `CONFIG_XILINX_PS_INIT_FILE` if you have
generated a custom version of it, e.g. for custom Zynq hardware.


Compiling U-Boot
----------------

Clone the U-Boot git repository (only needed once):

    git clone -b v2020.10 --depth 1 https://gitlab.denx.de/u-boot/u-boot.git

The `--depth 1` option will not download the entire git history, saving network
traffic in case you do not need it.

Build it (using the default configuration for the Zedboard):

    export CROSS_COMPILE=arm-linux-gnueabihf-
    export ARCH=arm
    export DEVICE_TREE=zynq-zed
    make xilinx_zynq_virt_defconfig
    make menuconfig    (if you want to edit the configuration)
    make

Copy the files `spl/boot.bin` and `u-boot.img` to the boot partition of the SD
card.


Distro configuration
--------------------

The default environment in U-Boot expects the information about the image to
boot and the kernel command line to come from a separate configuration file,
named `extlinux/extlinux.conf` on the boot partition of the SD card. The idea
seems to be to decouple this information (which may need to be updated by the
package manager on the target system) from the U-Boot configuration. Refer to
[`doc/README.distro`](https://gitlab.denx.de/u-boot/u-boot/-/blob/v2020.10/doc/README.distro)
in U-Boot for an in-depth discussion.

A minimal `extlinux.conf` suitable for our purposes looks as follows:

    label Linux
        kernel ../zImage
        append console=ttyPS0,115200 earlyprintk root=/dev/mmcblk0p2 rw rootwait
        devicetree ../zynq-zed-xrp.dtb

Note that the file needs to go into a directory named `extlinux` on the boot
partition of the SD card (i.e. the full path must be `extlinux/extlinux.conf`).

Alternatively, you can also modify the default environment to directly load the
desired image.


Debug UART
----------

If U-Boot crashes very early during startup, additional information may be
available by configuring the early debug UART. To do this, set the following
config options (for the Zedboard):

    CONFIG_DEBUG_UART_BASE=0xE0001000
    CONFIG_DEBUG_UART_CLOCK=50000000
    CONFIG_DEBUG_UART=y


Environment from SD card
------------------------

The U-Boot default configuration for the Zedboard loads the environment from
the SPI flash. If you prefer to store the environment on the SD card, unset the
`CONFIG_ENV_IS_IN_SPI_FLASH` config option and set `CONFIG_ENV_IS_IN_FAT=y` and
`CONFIG_ENV_FAT_DEVICE_AND_PART="0:1"`. By default, the file is called
`uboot.env` (`CONFIG_ENV_FAT_FILE`).


Generating uboot.env
--------------------

If you need to generate a modified version of the U-Boot environment on the
build system, do the following:

    make u-boot-initial-env

This will generate a human-readable file `u-boot-initial-env` that you can edit
as required. Finally, do

    tools/mkenvimage -s 0x20000 -o uboot.env u-boot-initial-env

to create the `uboot.env` file which can be put on the boot partition of the SD
card. Note that the `-s` option to mkenvimage is required. The value comes from
the `CONFIG_ENV_SIZE` config option (`grep CONFIG_ENV_SIZE .config`).

Normally, this should not be required, as you can edit and save the environment
from the U-Boot command line (on the target system).


Debugging U-Boot over JTAG
--------------------------

The Zedboard contains an FTDI-based interface to JTAG on the Zynq, which is
supported by [OpenOCD](http://openocd.org/). Start OpenOCD:

    openocd -f board/digilent_zedboard.cfg

In a separate window, do (in the directory where you built U-Boot):

    gdb-multiarch u-boot

and enter

    target extended-remote localhost:3333

to connect to the Zynq via OpenOCD.

For details, see [chapter 10 of the DENX U-Boot and Linux
Guide](https://www.denx.de/wiki/view/DULG/Debugging).
